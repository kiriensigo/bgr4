"use client";

import { Box, CardMedia } from "@mui/material";
import Link from "next/link";
import Image from "next/image";
import ImageNotSupportedIcon from "@mui/icons-material/ImageNotSupported";

interface GameImageCardProps {
  imageUrl: string;
  gameName: string;
  gameId: string;
  useNextImage?: boolean;
  aspectRatio?: string;
}

/**
 * ゲーム画像を表示するコンポーネント
 *
 * @param imageUrl - ゲーム画像のURL
 * @param gameName - ゲーム名（alt属性に使用）
 * @param gameId - ゲームID（リンク先に使用）
 * @param useNextImage - Next.jsのImageコンポーネントを使用するかどうか
 * @param aspectRatio - アスペクト比（デフォルトは1:1）
 */
export default function GameImageCard({
  imageUrl,
  gameName,
  gameId,
  useNextImage = false,
  aspectRatio = "1",
}: GameImageCardProps) {
  const linkHref = `/games/${gameId}`;

  // 実際の画像URLがあるかチェック（空文字、null、undefinedの場合は画像なしとして扱う）
  const hasRealImage = imageUrl && imageUrl.trim() !== "";

  // プレースホルダーコンポーネント
  const PlaceholderImage = () => (
    <Box
      sx={{
        width: "100%",
        aspectRatio: aspectRatio,
        display: "flex",
        flexDirection: "column",
        justifyContent: "center",
        alignItems: "center",
        backgroundColor: "grey.100",
        color: "grey.500",
        borderRadius: 1,
      }}
    >
      <ImageNotSupportedIcon sx={{ fontSize: 40, mb: 1 }} />
      <Box sx={{ fontSize: "0.75rem", textAlign: "center" }}>画像なし</Box>
    </Box>
  );

  return (
    <Link href={linkHref} style={{ textDecoration: "none" }}>
      {!hasRealImage ? (
        // 画像がない場合は直接プレースホルダーを表示（ネットワークリクエストなし）
        <PlaceholderImage />
      ) : useNextImage ? (
        <Box
          sx={{
            position: "relative",
            width: "100%",
            paddingTop: aspectRatio === "1" ? "100%" : "56.25%", // 1:1 or 16:9
            overflow: "hidden",
            borderRadius: 1,
          }}
        >
          <Image
            src={imageUrl}
            alt={gameName}
            fill
            sizes="(max-width: 600px) 100vw, (max-width: 900px) 50vw, 33vw"
            priority
            style={{
              objectFit: "contain",
              backgroundColor: "rgb(245, 245, 245)",
            }}
            onError={() => {
              // エラー時は何もしない（プレースホルダーは親コンポーネントで処理）
              console.warn(`Failed to load image: ${imageUrl}`);
            }}
          />
        </Box>
      ) : (
        <CardMedia
          component="img"
          image={imageUrl}
          alt={gameName}
          sx={{
            aspectRatio: aspectRatio,
            objectFit: "contain",
            bgcolor: "grey.100",
          }}
          onError={(e: React.SyntheticEvent<HTMLImageElement>) => {
            // エラー時はプレースホルダーに置き換える
            e.currentTarget.style.display = "none";
            e.currentTarget.parentElement!.innerHTML = `
              <div style="
                width: 100%; 
                aspect-ratio: ${aspectRatio}; 
                display: flex; 
                flex-direction: column; 
                justify-content: center; 
                align-items: center; 
                background-color: #f5f5f5; 
                color: #9e9e9e;
                border-radius: 4px;
              ">
                <svg style="width: 40px; height: 40px; margin-bottom: 8px;" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                </svg>
                <div style="font-size: 0.75rem; text-align: center;">
                  画像なし
                </div>
              </div>
            `;
          }}
        />
      )}
    </Link>
  );
}

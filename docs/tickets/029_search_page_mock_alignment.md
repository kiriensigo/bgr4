# チケット029: レビュー基準検索ページ実装（モック準拠）

## 概要
- `/search` ページをレビュー統計ベースの検索体験に刷新し、`/src/app/search/mock/page.tsx` のモックを本番実装へ落とし込む。
- おすすめプレイ人数・タグ（メカニクス）・カテゴリーのフィルタをスイッチ式トグルとして提供し、ゲーム詳細ページ統計と同じラベルで検索条件を構成できるようにする。
- 既存のレビュー集計 API (`/api/search/reviews`) を活用し、統計結果と同期した検索結果リストを提供する。

## ゴール
- レビュー統計を起点に「いま遊びたいボードゲーム」を見つけられる検索体験を実装する。
- モックが示す UI/UX（ヒーロー、検索フォーム、結果リスト、フィルタ群）を Next.js 本番ページで再現する。
- 推奨プレイ人数・メカニクス・カテゴリーのトグルがゲーム詳細ページ上部の統計セクションと 100% 一致した名称・選択肢で機能する。

## スコープ
- `/search` ページ（`src/app/search/page.tsx`）と関連する検索フォーム・結果コンポーネントの実装/更新。
- レビュー統計ベース検索フォーム（`IntegratedSearchForm` / `ReviewBasedSearchForm`）の UI・バリデーション・URL シンクロ強化。
- 検索結果表示（`SearchResultsList` など）のデータ整形、ローディング/エラー状態、アクセシビリティ調整。
- Supabase 経由で提供されるレビュー統計を用いた検索 API 呼び出しとフィルタパラメータの整備。

## 非スコープ
- 伝統的検索タブ（年/プレイ時間などの既存フィルタ）の抜本的改修。
- Supabase 側 RPC / 集計ロジックの新規開発（既存の加重統計 RPC を利用）。
- 多言語対応・ダークテーマ調整・完全なレスポンシブデザイン改善（致命的な崩れがある場合のみ対応）。

## 参照リソース
- モック: `bgr-v2/src/app/search/mock/page.tsx`
- モックフォーム: `bgr-v2/src/components/search/ReviewBasedSearchForm.tsx`
- 現行ページ: `bgr-v2/src/app/search/page.tsx`
- 詳細ページ統計: `bgr-v2/src/components/games/GameStatsComponent.tsx`, `bgr-v2/src/hooks/useGameStats.ts`
- 検索 API: `bgr-v2/src/app/api/search/reviews/route.ts`

## 実装フェーズと主なタスク
### Phase 1: フィルタ設計とデータソース整理
- [ ] ゲーム詳細統計と同名のメカニクス／カテゴリー／推奨プレイ人数ラベルを検索フォームから取得できるようにユーティリティを共通化（例: `searchOptions.ts` など）。
- [ ] `/api/search/reviews` から返却される `popular_mechanics`, `popular_categories`, `popular_player_counts` を結果カード表示・フィルタロジックで再利用できるよう整形。
- [ ] 既存の静的配列（MECHANICS/CATEGORIES）と API マッピング（review route 内）を突き合わせ、欠損や表記揺れを洗い出す。

### Phase 2: UI コンポーネント実装
- [ ] おすすめプレイ人数・メカニクス・カテゴリーの選択 UI を `Switch` または `ToggleGroup` ベースのスイッチ式トグルに差し替え（アクセシビリティ対応）。
- [ ] スイッチ群の選択状態をバッジやカウンタで可視化し、アクティブフィルタ数をモック同様に表示。
- [ ] 推奨プレイ人数トグルの表示順序・ラベル（`2人 / 3人 / 4人 / 5人 / 6人以上`）を `useGameStats` と共通化。
- [ ] レビュー指標スライダー（総合評価/ルール難度/運要素/インタラクション/ダウンタイム）およびプレイ時間スライダーの UI をモック準拠で調整。

### Phase 3: 検索処理とページ統合
- [ ] フォーム送信でレビュー検索 API を呼び出し、ローディング・成功・エラー状態の UI を整理。
- [ ] URL クエリとフィルタ状態を同期し、ページリロードや共有時に同じ条件が再現されるようにする。
- [ ] 検索結果カードへ推奨プレイ人数・メカニクス・カテゴリーをタグとして表示し、フィルタと一致する項目が視覚的に分かるようにする。
- [ ] ページネーション・ソート UI をモックに沿って再配置し、API レスポンスに合わせた情報（件数、平均値など）を表示。

### Phase 4: QA と仕上げ
- [ ] `jest` / `@testing-library/react` でフィルタトグルの ON/OFF、URL パラメータ生成、API 呼び出しハンドラのテストを追加。
- [ ] `playwright` e2e で代表的なフィルタ組み合わせ（例: 3人推奨 + ワーカープレイスメント + 協力）による検索動作を検証。
- [ ] Lighthouse ないし手動で主要ブレイクポイント（モバイル/デスクトップ）表示確認。
- [ ] ドキュメント（README もしくは `docs/` 配下）に検索ページ利用方法/制約を追記。

## データ・フィルタ仕様メモ
- 推奨プレイ人数: `[2, 3, 4, 5, 7]`（7 は “6人以上” 表示）。`popular_player_counts` セットと一致させる。
- メカニクス/カテゴリー: `useGameStats` が返す日本語ラベルをそのまま利用し、API 側マッピング（`mechanicsMapping` / `categoriesMapping`）と同一に保つ。
- AND 条件: メカニクス・カテゴリーは AND（全て含む）でフィルタ、推奨プレイ人数は OR（いずれか一致）。仕様が変わる場合は API と合わせて調整。
- プレイ時間: 15〜180分（180 は “180分以上” として扱う）。

## 受け入れ条件
- スイッチ式トグルを操作すると URL クエリと検索結果が即時に一致する。
- 推奨プレイ人数・メカニクス・カテゴリーの選択肢と表記がゲーム詳細統計のチップと完全一致する。
- API が返す `popular_*` 情報が結果カードに表示され、選択したフィルタが強調される。
- ローディング・エラー・ゼロ件時の UI がモックの意図を満たす形で用意されている。
- E2E / 単体テストが追加され、CI 上でパスする。

## テスト戦略
- 単体: フィルタビルダー（URL パラメータ生成）、トグル状態更新、結果リスト整形関数。
- コンポーネント: `IntegratedSearchForm` のレンダリング、スイッチ操作、リセットボタン挙動。
- E2E: `/search` ページでの代表的フィルタ操作、検索結果反映、URL シェア再現性。

## リスクと留意事項
- API が返す日本語ラベルと UI 表記のズレがあるとフィルタが機能しないため、共通定義の重複を排除すること。
- ボタンからスイッチへの変更に伴い、既存のスタイルシートやレスポンシブ挙動が崩れないか要確認。
- Supabase 呼び出し回数が増える場合、デバウンスやキャッシュ戦略を検討（初期段階ではフォーム送信時のみ呼び出す想定）。

## 作業ボリューム目安
- フロントエンド実装: 2.0 人日
- API 整備・データ確認: 0.5 人日
- テスト & QA: 0.5 人日

## 依存・関連タスク
- レビュー統計 API (`/api/search/reviews`) の安定運用。
- ゲーム詳細ページ統計の用語統一タスク（ある場合）。
- Playwright テスト基盤（`bgr-v2/e2e`）の最新化。
